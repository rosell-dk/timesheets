var Formula=function(a,d,c){this.backReference=c;this.resultChangedCallBack=d;thisFormula=this;this.numberOfCalculationsLately=0;window.setInterval(function(){10<thisFormula.numberOfCalculationsLately&&(alert("oh-oh. Too much recursion. Stopping formula: "+options.formula),thisFormula.stoppedBecauseTooMuchRecursion=!0);thisFormula.numberOfCalculationsLately=0},100);this.formulaFragment=Formula.parseFormula(a,this);this.bindReferences()};
Formula.prototype.bindReferences=function(){void 0!==this.formulaFragment&&this.formulaFragment.addChangeHandlers(this)};Formula.prototype.unbindReferences=function(){void 0!==this.formulaFragment&&this.formulaFragment.removeChangeHandlers(this)};Formula.prototype.triggerChangeCallback=function(){"function"==typeof this.resultChangedCallBack&&this.resultChangedCallBack()};Formula.prototype.calc=function(){return this.parseError()?"Invalid formula":this.formulaFragment.calc()};
Formula.prototype.referenceChanged=function(a){this.resultChangedCallBack()};Formula.prototype.parseError=function(){return void 0===this.formulaFragment};
Formula.parseFormula=function(a,d){function c(){if(-1==e[g]){var a=l();if(void 0!==a)return a}else if(-4==e[g])return g+=2,e[g-1]}function l(){if(-1==e[g]){g++;var a=e[g];g++;for(var b=[];-2!=e[g];)if(b.push(c()),void 0===b[b.length-1])return;g++;return new Formula.Fragment(a,b,d)}}var k=0,b=a.trim(),e=[],m=/^([A-Z_\$]+[0-9A-Z_\$]*)\(/,p=/^[-+]?[0-9]/,q=/^([-+]{0,1}(?:(?:[0-9]+[.][0-9]+)|(?:[0-9]+)))/,r=/^"((?:[^"]|"")*)"/,g=0;a:for(;""!=b&&99>g;)if(b=b.trimLeft(),g++,m.test(b)){k++;var f=m.exec(b)[1];
if(!Formula.functions[f])return;e.push(-1);e.push(f);b=b.substr(b.indexOf("(")+1)}else if(p.test(b)){f=q.exec(b);if(null==f)return;var h=parseFloat(f[1]);if(isNaN(h))return;e.push(-4);e.push(h);b=b.substr(f[0].length)}else if('"'==b[0]){f=r.exec(b);if(null==f){console.log("Parser found something that looked like a string, but wasnt. Parse error!");return}h=f[1].replace(/""/g,'"');e.push(-4);e.push(h);b=b.substr(f[0].length)}else{if(!(0<k)||","!=b[0]&&")"!=b[0]){f=/^([^,\)]+)(?:$|[,\)])/.exec(b);if(null==
f)return;f=f[1];b=b.substr(f.length);for(h=0;h<Formula.parsers.length;h++){var n=Formula.parsers[h](f,d);if(void 0!==n){e.push(-4);e.push(n);continue a}}return}if(0<k)if(","==b[0])b=b.substr(1);else if(")"==b[0])k--,e.push(-2),b=b.substr(1);else return null}g=0;-4==e[0]&&(e.unshift(-1,"PASSTHROUGH"),e.push(-2));return l()};Formula.function_names=[];Formula.functions={};Formula.addFunction=function(a,d){Formula.function_names.push(a);Formula.functions[a]=d};
Formula.addFunctions=function(){for(var a=0;a<arguments.length;a++)Formula.function_names.push(arguments[a][0]),Formula.functions[arguments[a][0]]=arguments[a][1]};Formula.addFunction("PASSTHROUGH",function(a){return a});Formula.parsers=[];Formula.addParser=function(a,d){void 0===d?Formula.parsers.push(a):Formula.parsers.splice(1,0,a)};Formula.addParser(function(a){if("false"==a.toLowerCase())return!1;if("true"==a.toLowerCase())return!0});
Formula.Fragment=function(a,d,c){this.fname=a;this.parameters=d;this.formulaObj=c};Formula.Fragment.prototype.calc=function(){for(var a=[],d=0;d<this.parameters.length;d++){var c=this.parameters[d];c instanceof Formula.Fragment?c=c.calc():"function"===typeof c.getValue&&(c=c.getValue());a.push(c)}return Formula.functions[this.fname].apply({formula:this.formulaObj},a)};
Formula.Fragment.prototype.addChangeHandlers=function(a){for(var d=0;d<this.parameters.length;d++){var c=this.parameters[d];c instanceof Formula.Fragment?c.addChangeHandlers(a):"function"===typeof c.setChangeCallback&&c.setChangeCallback(function(){a.referenceChanged(this)})}};
Formula.Fragment.prototype.removeChangeHandlers=function(a){for(var d=0;d<this.parameters.length;d++){var c=this.parameters[d];c instanceof Formula.Fragment?c.removeChangeHandlers(a):"function"===typeof c.removeChangeCallback&&c.removeChangeCallback(function(){a.referenceChanged(this)})}};

